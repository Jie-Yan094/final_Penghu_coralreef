import solara
import geemap.foliumap as geemap
import ee
import os
import json
import tempfile
import pandas as pd
import plotly.graph_objects as go
from google.oauth2.service_account import Credentials

# ... (GEE é©—è­‰èˆ‡åˆå§‹åŒ–éƒ¨åˆ†ä¿æŒä¸è®Š) ...

# ==========================================
# 1. æ ¸å¿ƒè³‡æ–™èˆ‡ç‹€æ…‹è¨­å®š
# ==========================================
coral_display_type = solara.reactive("ç¡¬çŠç‘š")

# ==========================================
# 2. é é¢çµ„ä»¶
# ==========================================

@solara.component
def Page():
    # è¨­å®šç¶²é ä¸»å®¹å™¨å¯¬åº¦èˆ‡é‚Šè·
    with solara.Column(style={"width": "100%", "padding": "20px", "max-width": "1200px", "margin": "0 auto"}):
        
        # --- ç¶²ç«™å¤§æ¨™é¡Œ ---
        solara.Markdown("# ğŸŒŠ æ¾æ¹–æµ·åŸŸç”Ÿæ…‹å®ˆè­·è¡Œå‹•å¹³å°")
        solara.Markdown("### å®ˆè­·æ ¸å¿ƒï¼š1.çŠç‘šå¾©è‚²èˆ‡æ¸…æ˜Ÿ | 2.æµ·è‰åºŠé‡å»º | 3.æµ·æ´‹å»¢æ£„ç‰©(é¬¼ç¶²)æ¸…ç†")
        
        solara.Divider()

        # --- 1. çŠç‘šå€å¡Š (æ¸…é™¤æµ·æ˜Ÿã€å¾©è‚²) ---
        with solara.Card("ğŸ›¡ï¸ è¡Œå‹•ä¸€ï¼šçŠç‘šå®ˆè­·èˆ‡å¾©è‚² (æ¸…æ˜Ÿè¡Œå‹•ã€çŠç‘šå¾©è‚²)"):
            with solara.Row(gap="20px", style={"flex-wrap": "wrap"}):
                # å·¦å´ï¼šçŠç‘šç¾æ³èªªæ˜
                with solara.Column(style={"flex": "1", "min-width": "450px"}):
                    solara.Markdown("#### ğŸª¸ çŠç‘šç¤ç¾æ³")
                    solara.Markdown("æ¾æ¹–æµ·åŸŸçŠç‘šç¤å› æ°£å€™è®Šé·ã€æµ·æ´‹é…¸åŒ–èˆ‡äººç‚ºå¹²æ“¾ï¼Œè¿‘å¹´ä¾†å‘ˆç¾è¡°é€€è¶¨å‹¢ã€‚")
                    solara.Markdown("ç›®å‰ä¸»è¦ä»¥ç¡¬çŠç‘šç‚ºä¸»ï¼Œè»ŸçŠç‘šæ¯”ä¾‹è¼ƒä½ã€‚")

                # å³å´ï¼šæ¸…æ˜Ÿè¡Œå‹•èªªæ˜
                with solara.Column(style={"flex": "1", "min-width": "450px", "background-color": "#f0f7ff", "padding": "20px", "border-radius": "10px"}):
                    solara.Markdown("#### âš”ï¸ æ£˜å† æµ·æ˜Ÿ(COTS)äººå·¥æ¸…é™¤å°ç­–")
                    with solara.Column():
                        solara.Markdown("##### **A. ç‰©ç†ç§»é™¤ï¼šäººå·¥å¤¾å–**")
                        solara.Markdown("* é©ç”¨æ–¼å°è¦æ¨¡çˆ†ç™¼æˆ–åˆæ¢æœŸï¼Œéœ€ç”±å°ˆæ¥­æ½›æ°´å“¡ä½¿ç”¨é•·å¤¾å°‡æµ·æ˜Ÿç§»å…¥ç¶²è¢‹å¸¶å›å²¸ä¸Šè™•ç†ã€‚")
                        
                        solara.Markdown("##### **B. ç”Ÿç‰©åŒ–å­¸ï¼šé†‹é…¸æ³¨å°„æ³•**")
                        solara.Markdown("* **å„ªé»ï¼š** æ•ˆç‡é«˜ã€ä¸éœ€å¸¶å›å²¸ä¸Šã€ä¸æœƒå¼•ç™¼æµ·æ˜Ÿæ–·è‚¢å†ç”Ÿã€‚\n* **æ–¹æ³•ï¼š** ä½¿ç”¨æ³¨å°„æ§å°‡é£Ÿç”¨é†‹æ³¨å…¥æµ·æ˜Ÿé«”å…§ï¼Œå…¶æ®˜éª¸æœƒè‡ªç„¶åˆ†è§£å›æ­¸ç”Ÿæ…‹éˆã€‚")
                    
                    solara.Markdown("#### ğŸŒ¿ çŠç‘šå¾©è‚²æŠ€è¡“")
                    solara.Markdown("* **çŠç‘šç¨®æ¤ï¼š** æ¡é›†å¤©ç„¶æ®˜æï¼Œæ–¼é™¸åŸŸé¤Šæ®–ä¸­å¿ƒåŸ¹è‚²å¾Œï¼Œå†åˆ©ç”¨ä¸é½é‹¼æ¶æˆ–ç”Ÿæ…‹ç£šé€²è¡Œæµ·åŸŸç§»æ¤å¾©è‚²ã€‚")

        # --- 2. æµ·è‰åºŠå¾©è‚²å€å¡Š ---
        with solara.Card("ğŸŒ± è¡Œå‹•äºŒï¼šæµ·è‰åºŠå¾©è‚² (Seagrass Restoration)"):
            with solara.Row(gap="20px", style={"flex-wrap": "wrap"}):
                with solara.Column(style={"flex": "1", "min-width": "450px"}):
                    solara.Markdown("#### ğŸ›°ï¸ æµ·è‰åºŠ")
                    
                    solara.Markdown("#### ğŸŒŠ æµ·è‰åºŠçš„é‡è¦æ€§")
                    solara.Markdown("""
                    æµ·è‰åºŠæ˜¯æµ·æ´‹çš„ã€Œè—ç¢³ã€è‹±é›„ï¼Œèƒ½æœ‰æ•ˆå›ºç¢³ã€æ·¨åŒ–æ°´è³ªä¸¦æä¾›å¹¼é­šæ£²æ¯ç©ºé–“ã€‚
                    * **å¾©è‚²è¡Œå‹•ï¼š** æ¾æ¹–ç›®å‰æ–¼å…§æµ·é€²è¡Œã€Œæµ·è‰è‹—ç§»æ¤ã€ï¼Œé€éäººå·¥å›ºå®šå·¥æ³•ï¼Œå”åŠ©æµ·è‰åœ¨æ²™è³ªåœ°ç´®æ ¹ã€‚
                    * **ç›£æ¸¬æŒ‡æ¨™ï¼š** é€éè¡›æ˜Ÿå½±åƒç›£æ¸¬æµ·è‰åºŠè¦†è“‹ç‡ä¹‹å¹´åº¦è®Šé·ã€‚
                    """)

        # --- 3. æµ·æ´‹å»¢æ£„ç‰©æ¸…ç†å€å¡Š ---
        with solara.Card("ğŸ—‘ï¸ è¡Œå‹•ä¸‰ï¼šæµ·æ´‹å»¢æ£„ç‰©æ¸…ç† (æ¼ç¶²ã€å»¢æ£„ç‰©ç›£æ¸¬)"):
            solara.Markdown("#### ğŸ•¸ï¸ é¬¼ç¶² (Ghost Nets) æ¸…é™¤è¨ˆç•«")
            solara.Markdown("å»¢æ£„æ¼ç¶²ï¼ˆé¬¼ç¶²ï¼‰æ˜¯çŠç‘šç¤çš„æ²ˆé»˜æ®ºæ‰‹ï¼Œæœƒè¦†è“‹çŠç‘šå°è‡´å…¶æ­»äº¡ï¼Œä¸¦çºç¹æµ·é¾œç­‰ç”Ÿç‰©ã€‚")
            
        
        # --- é å°¾ ---
        solara.Markdown("<br>")
        
        solara.Divider()
        solara.Markdown("Â© 2025 æ¾æ¹–çŠç‘šç¤ç”Ÿæ…‹å®ˆè­·å°ˆæ¡ˆ | æ•¸æ“šä¾†æºï¼šEE, iOcean, æ¾æ¹–ç¸£æ”¿åºœ", style="color:gray; text-align:center")

# ==========================================
# 3. åŸ·è¡Œ
# ==========================================
# æ­¤è™•éœ€ç¢ºä¿æ‚¨ä¹‹å‰çš„ SSTCoralChart, NDCIMap, CorrelationAnalysis ç­‰çµ„ä»¶ä»£ç¢¼éƒ½åœ¨ä¸Šæ–¹å®šç¾©å¥½